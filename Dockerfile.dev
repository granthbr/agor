# Development Dockerfile for Agor
# Supports hot-reload for both daemon and UI
FROM node:20-slim

# Install pnpm
RUN npm install -g pnpm@9.15.1

# Set working directory
WORKDIR /app

# Copy package files for dependency installation
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/agor-daemon/package.json ./apps/agor-daemon/
COPY apps/agor-ui/package.json ./apps/agor-ui/
COPY apps/agor-cli/package.json ./apps/agor-cli/
COPY packages/core/package.json ./packages/core/
COPY packages/drizzle-schema/package.json ./packages/drizzle-schema/

# Install dependencies
RUN pnpm install --frozen-lockfile

# Copy source code
COPY . .

# Create .agor directory for database and config
RUN mkdir -p /root/.agor

# Expose UI port only (daemon is internal)
EXPOSE ${VITE_PORT:-5173}

# Default command: run both daemon and UI in dev mode
# Daemon runs on internal port 3030, UI on configurable VITE_PORT
CMD ["sh", "-c", "pnpm --filter @agor/daemon dev & pnpm --filter agor-ui dev --host 0.0.0.0 --port ${VITE_PORT:-5173}"]
